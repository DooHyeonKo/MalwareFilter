using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace MalwareFilter.ScanEngine.Module
{
    class PDF
    {
        public string VirusName = "";
        public string FileLocation = "";
        public string EngineName = "PDF Scan Engine";

        public KavKernel.ScanResult ScanFile(string FilePath)
        {
            KavKernel.ScanResult mScanResult = KavKernel.ScanResult.NotInfected;

            if (File.Exists(FilePath) || Path.GetExtension(FilePath).Contains("pdf"))
            {
                bool IsPdf = IsPdfFile(FilePath);

                if (IsPdf)
                {
                    byte[] buffer = null;
                    FileStream fs = new FileStream(FilePath, FileMode.Open, FileAccess.Read);
                    BinaryReader br = new BinaryReader(fs);
                    long numBytes = new FileInfo(FilePath).Length;

                    buffer = br.ReadBytes((int)fs.Length);
                    var enc = new ASCIIEncoding();
                    var header = enc.GetString(buffer);

                    if (Regex.IsMatch(header, @"^s*%PDF-1.")) // Is PDF Header
                    {
                        if (Regex.IsMatch(header, @"this\.exportDataObject.+?cName:.+?nLaunch"))
                        {
                            VirusName = "Trojan-PDF/Generic";
                            FileLocation = FilePath;

                            //cQuarantineFile.AddQuarantineFile(FilePath, "PDF/Generic");

                            mScanResult = KavKernel.ScanResult.Infected;
                        }

                    }

                }
            }
            else
            {
                mScanResult = KavKernel.ScanResult.NotFoundPath;
            }

            return mScanResult;
        }

        private bool IsPdfFile(string filePath)
        {
            bool IsPdf = false;

            byte[] buffer = null;
            FileStream fs = new FileStream(filePath, FileMode.Open, FileAccess.Read);
            BinaryReader br = new BinaryReader(fs);
            long numBytes = new FileInfo(filePath).Length;

            buffer = br.ReadBytes(5);
            var enc = new ASCIIEncoding();
            var header = enc.GetString(buffer);

            if (buffer[0] == 0x25 && buffer[1] == 0x50 && buffer[2] == 0x44 && buffer[3] == 0x46 && buffer[4] == 2D)
            {
                IsPdf = true;
            }

            return IsPdf;
        }
    }
}
